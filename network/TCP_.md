# TCP

| 版本/状态 | 责任人 | 起止日期   | 备注        |
| --------- | ------ | ---------- | ----------- |
| V1.0/草稿 | 蔡政和 | 2019/03/20 | 创建TCP文档 |

## 握手流程

三次握手：

1. SYN：服务器确认客户端的发信能力和服务器的收信能力。
2. ACK，SYNC：客户端确认客户端的发信、收信能力、服务器的发信、收信能力。
3. ACK：服务器确认客户端的收信能力和服务器的发信能力。

四次挥手：

1. C->S：FIN
2. S->C：ACK
3. S->C：FIN
4. C->S：ACK

## 滑动窗口

流量控制的一种机制，接收端告知通告窗口大小，控制发送端发送的数据流量。

滑动窗口分为三个动作：左边沿右移（合拢）；右边沿右移（张开）；右边沿左移（收缩）

通常来说，窗口大小可以缩小，但是右边沿不会左移。

## 拥塞控制

### 带宽时延乘积

$$
capacity(bit)=bandwidth(b/s) * RTT(s)
$$

该值依赖于网络速度（带宽）和两端的时延（RTT），可以理解为是发送端到接收端之间通路的容量。

### 慢启动

慢启动为发送端提供了另一个窗口：拥塞窗口（cwnd）。拥塞窗口被初始化为1个报文段，当收到接收端的应答时，拥塞窗口更新为2，以此类推，按指数次递增。

发送端取拥塞窗口和通告窗口的最小值作为发送上限。

### 拥塞避免

当带宽时延乘积到达路由器的极限时，分组将被丢弃。拥塞避免算法是一种处理丢失分组的方法。

分组丢失意味着在源主机到目的主机的某处网络发生了拥塞。有两种场景：发生超时和收到重复的ACK。

当拥塞发生时，我们希望降低分组进入网络的速率，此时可以结合慢启动和拥塞控制算法来解决该问题。需要维持两个变量：拥塞窗口（cwnd）和慢启动门限（ssthresh）。

算法的工作流程如下：

1. 初始状态下，cwnd为1个报文段，ssthresh为65535个字节。
2. 当发生拥塞时（超时或重复确认），ssthresh被设置成当前窗口大小的一半（cwnd和接收方通告窗口大小的最小值，但至少为2个报文段）。此外，如果是超时引起的拥塞，则将cwnd设置为1（慢启动）。
3. 当新的数据被对方确认，就增加cwnd。增加的方法依赖于当前正在慢启动还是拥塞避免：若cwnd小于ssthresh，则是慢启动；否则是拥塞避免。慢启动一直持续到发生拥塞时窗口大小的一半时才停止（即步骤2中的ssthresh）。
4. 当进行慢启动时，每次收到一个ACK cwnd增加1（指数增长）；当进行拥塞避免时，每过一个RTT cwnd增加1（加性增长）。

## 超时重传

### 指数退避

超时时间按倍乘关系增长：1、3、6、12、24、48和多个64秒。

从第一次超时重传到最后发送RESET标志的间隔大约为9分钟。

### 往返时间测量

TODO

### 快速重传算法

- 发送端会对收到的重复ACK进行计数，当收到第3个时，就假定一个报文段已经丢失并重传自那个序号起的一个报文段。
- 对接收端来说，当收到失序的报文段时，会保存这些失序的报文段并不断发送期望获取的正常序号的报文段，此时通告窗口也会不断变小。
- 接收端收到丢失的分组后，会取出所有缓存的报文段进行确认，并更新通告窗口的大小。



